<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/images/logo.svg" color="#222"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"moeyui1.github.io",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!0,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="本文基于 knative 文档中的 Orchestrating a source-to-URL deployment on Kubernetes 的简单例子，通过从源码到 URL 的部署流程一窥 Knative 给 Kubernetes 带来的改变。"><meta property="og:type" content="article"><meta property="og:title" content="通过Knative在Kubernetes上策划一次从源码到URL的部署"><meta property="og:url" content="http://moeyui1.github.io/%E5%BC%80%E5%8F%91/7184eb1f.html"><meta property="og:site_name" content="不是很懂"><meta property="og:description" content="本文基于 knative 文档中的 Orchestrating a source-to-URL deployment on Kubernetes 的简单例子，通过从源码到 URL 的部署流程一窥 Knative 给 Kubernetes 带来的改变。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2019-03-09T14:35:11.000Z"><meta property="article:modified_time" content="2021-02-08T10:12:18.761Z"><meta property="article:author" content="moeyui"><meta property="article:tag" content="kubernetes"><meta property="article:tag" content="serverless"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://moeyui1.github.io/%E5%BC%80%E5%8F%91/7184eb1f.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>通过Knative在Kubernetes上策划一次从源码到URL的部署 | 不是很懂</title><script>function sendPageView(){if(CONFIG.hostname===location.hostname){var e=localStorage.getItem("uid")||Math.random()+"."+Math.random();localStorage.setItem("uid",e),navigator.sendBeacon("https://www.google-analytics.com/collect",new URLSearchParams({v:1,tid:"UA-75483578-1",cid:e,t:"pageview",dp:encodeURIComponent(location.pathname)}))}}document.addEventListener("pjax:complete",sendPageView),sendPageView()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><script>function loadCss(e){var n=document,s=n.head,t=n.createElement("link");t.rel="stylesheet",t.href=e,function e(s){if(n.body)return s();setTimeout(function(){e(s)})}(function(){s.appendChild(t)})}loadCss("/style.css"),loadCss("//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"),loadCss("//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css")</script><noscript><link rel="stylesheet" href="/style.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"></noscript></head><body itemscope="" itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">不是很懂</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">不是很懂你们程序员</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> 首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> 归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i> 分类</a></li></ul></nav></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/moeyui1" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://moeyui1.github.io/%E5%BC%80%E5%8F%91/7184eb1f.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/blogAvatar.jpg"><meta itemprop="name" content="moeyui"><meta itemprop="description" content="moeyui | moeyui's blog"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="不是很懂"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 通过Knative在Kubernetes上策划一次从源码到URL的部署</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-03-09 22:35:11" itemprop="dateCreated datePublished" datetime="2019-03-09T22:35:11+08:00">2019-03-09</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-02-08 18:12:18" itemprop="dateModified" datetime="2021-02-08T18:12:18+08:00">2021-02-08</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a></span></span><span id="/%E5%BC%80%E5%8F%91/7184eb1f.html" class="post-meta-item leancloud_visitors" data-flag-title="通过Knative在Kubernetes上策划一次从源码到URL的部署" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Valine：</span><a title="valine" href="/%E5%BC%80%E5%8F%91/7184eb1f.html#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/%E5%BC%80%E5%8F%91/7184eb1f.html" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><p>本文基于 knative 文档中的 <a target="_blank" rel="noopener" href="https://github.com/knative/docs/blob/master/serving/samples/source-to-url-go/README.md#orchestrating-a-source-to-url-deployment-on-kubernetes">Orchestrating a source-to-URL deployment on Kubernetes</a> 的简单例子，通过从源码到 URL 的部署流程一窥 Knative 给 Kubernetes 带来的改变。</p><span id="more"></span><h2 id="环境需求"><a href="#环境需求" class="headerlink" title="环境需求"></a>环境需求</h2><ul><li>一个安装了 Knative 的 Kubernetes 集群。如果你需要创建一个，按照<a target="_blank" rel="noopener" href="https://github.com/knative/docs/blob/master/install/README.md">安装步骤</a>来。</li><li>安装并配置了 Go。这是可选的，仅当你想要在本地运行示例应用时需要。</li></ul><h2 id="配置-Knative"><a href="#配置-Knative" class="headerlink" title="配置 Knative"></a>配置 Knative</h2><p>源码的构建是由 Knative build 子系统完成的，通常我们需要在构建配置中定义一些构建步骤(step)，通过这些构建步骤一步步地处理源码，详细可以参考 <a target="_blank" rel="noopener" href="https://github.com/knative/docs/blob/master/build/builds.md#knative-build-resources">Knative Build resources</a>。但 Knative 也支持使用多种构建模板，下文就介绍如何使用 kaniko 构建模板完成示例代码的构建。</p><h3 id="安装-kaniko-构建模板"><a href="#安装-kaniko-构建模板" class="headerlink" title="安装 kaniko 构建模板"></a>安装 kaniko 构建模板</h3><p>本示例借助 <a target="_blank" rel="noopener" href="https://github.com/knative/build-templates/tree/master/kaniko">kaniko build template</a> 来在你的 Kubernetes 集群上执行一次“从源码到容器”的构建。</p><blockquote><p><a target="_blank" rel="noopener" href="https://github.com/GoogleCloudPlatform/kaniko">kaniko</a> 是谷歌开源的用于从 Dockerfile 构建容器镜像的工具。它的特点在于不依赖 Docker daemon，并在用户空间内执行 Dockerfile 中的每一行命令。这使得在一些不能方便地或安全地运行 Docker daemon 的环境中，如标准 Kubernetes 集群中，也能构建容器镜像。</p></blockquote><p>使用 kubectl 来安装 kaniko：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply --filename https://raw.githubusercontent.com/knative/build-templates/master/kaniko/kaniko.yaml</span><br></pre></td></tr></tbody></table></figure><h3 id="填写-Docker-Hub-的密钥"><a href="#填写-Docker-Hub-的密钥" class="headerlink" title="填写 Docker Hub 的密钥"></a>填写 Docker Hub 的密钥</h3><p>为了将从源代码构建得到的容器推送到 Docker Hub，需要在 Kubernetes 上登记密钥用于认证 Docker Hub。</p><p>关于 Knative 中的认证，这是<a target="_blank" rel="noopener" href="https://github.com/knative/docs/blob/master/build/auth.md#basic-authentication-docker">详细的说明</a>，下面是几个关键步骤：</p><ol><li><p>创建一个 <code>Secret</code> 配置，用于存放你的 Docker Hub 认证信息。将文件保存为 <code>docker-secret.yaml</code>：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">basic-user-pass</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">build.knative.dev/docker-0:</span> <span class="string">https://index.docker.io/v1/</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/basic-auth</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># Use 'echo -n "username" | base64' to generate this string</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">BASE64_ENCODED_USERNAME</span></span><br><span class="line">  <span class="comment"># Use 'echo -n "password" | base64' to generate this string</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">BASE64_ENCODED_PASSWORD</span></span><br></pre></td></tr></tbody></table></figure></li><li><p>上面的配置中，<code>username</code> 和 <code>password</code> 都是需要 base64 加密的。在 macOS 或 Linux 系统中，用下面的命令可以生成 base64 编码的值：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -n <span class="string">"username"</span> | base64 -w 0</span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"password"</span> | base64 -w 0</span><br></pre></td></tr></tbody></table></figure><blockquote><p>注意：如果在 macOS 上提示 “invalid option -w” 错误，试着改成<code>base64 -b 0</code>。</p></blockquote></li><li><p>创建一个<code>Service Account</code>配置，用于将构建进程链接到<code>Secret</code>。将文件保存为<code>service-account.yaml</code>：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">build-bot</span></span><br><span class="line"><span class="attr">secrets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">basic-user-pass</span></span><br></pre></td></tr></tbody></table></figure></li><li><p>创建好配置文件后，通过<code>kubectl</code>将它们应用到你的集群：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f docker-secret.yaml</span><br><span class="line">kubectl apply -f service-account.yaml</span><br></pre></td></tr></tbody></table></figure></li></ol><h2 id="部署示例"><a href="#部署示例" class="headerlink" title="部署示例"></a>部署示例</h2><p>本示例使用 <a target="_blank" rel="noopener" href="https://github.com/mchmarny/simple-app">github.com/mchmarny/simple-app</a> 作为一个基础 Go 应用，但你也可以替换为你自己的 GitHub 项目。唯一要注意的是，项目必须包含一个<code>Dockerfile</code>来描述如何为应用构建一个容器。</p><ol><li><p>需要创建一个 service 配置来定义服务如何部署，包括源代码在哪儿、使用哪个构建模板。创建<code>service.yaml</code>并复制如下定义。将<code>{DOCKER_USERNAME}</code>替换为你自己的 Docker Hub 用户名：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">serving.knative.dev/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-from-source</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">runLatest:</span></span><br><span class="line">    <span class="attr">configuration:</span></span><br><span class="line">      <span class="attr">build:</span></span><br><span class="line">        <span class="attr">apiVersion:</span> <span class="string">build.knative.dev/v1alpha1</span></span><br><span class="line">        <span class="attr">kind:</span> <span class="string">Build</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">serviceAccountName:</span> <span class="string">build-bot</span></span><br><span class="line">          <span class="attr">source:</span></span><br><span class="line">            <span class="attr">git:</span></span><br><span class="line">              <span class="attr">url:</span> <span class="string">https://github.com/mchmarny/simple-app.git</span></span><br><span class="line">              <span class="attr">revision:</span> <span class="string">master</span></span><br><span class="line">          <span class="attr">template:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">kaniko</span></span><br><span class="line">            <span class="attr">arguments:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">IMAGE</span></span><br><span class="line">                <span class="attr">value:</span> <span class="string">docker.io/{DOCKER_USERNAME}/app-from-source:latest</span></span><br><span class="line">      <span class="attr">revisionTemplate:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">container:</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">docker.io/{DOCKER_USERNAME}/app-from-source:latest</span></span><br><span class="line">            <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">            <span class="attr">env:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SIMPLE_MSG</span></span><br><span class="line">                <span class="attr">value:</span> <span class="string">"Hello from the sample app!"</span></span><br></pre></td></tr></tbody></table></figure></li><li><p>使用<code>kubectl</code>应用配置，并观察结果：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f service.yaml</span><br><span class="line">kubectl get po --watch</span><br></pre></td></tr></tbody></table></figure><p> 输出类似于：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NAME                          READY     STATUS       RESTARTS   AGE</span><br><span class="line">app-from-source-00001-zhddx   0/1       Init:2/3     0          7s</span><br><span class="line">app-from-source-00001-zhddx   0/1       PodInitializing   0         37s</span><br><span class="line">app-from-source-00001-zhddx   0/1       Completed   0         38s</span><br><span class="line">app-from-source-00001-deployment-6d6ff665f9-xfhm5   0/3       Pending   0         0s</span><br><span class="line">app-from-source-00001-deployment-6d6ff665f9-xfhm5   0/3       Pending   0         0s</span><br><span class="line">app-from-source-00001-deployment-6d6ff665f9-xfhm5   0/3       Init:0/1   0         0s</span><br><span class="line">app-from-source-00001-deployment-6d6ff665f9-xfhm5   0/3       Init:0/1   0         2s</span><br><span class="line">app-from-source-00001-deployment-6d6ff665f9-xfhm5   0/3       PodInitializing   0         3s</span><br><span class="line">app-from-source-00001-deployment-6d6ff665f9-xfhm5   2/3       Running   0         6s</span><br><span class="line">app-from-source-00001-deployment-6d6ff665f9-xfhm5   3/3       Running   0         11s</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p> 能看到先是<code>app-from-source-00001</code>启动，执行“从源码到镜像”的过程，再启动<code>app-from-source-00001-deployment</code>拉取镜像，提供服务。</p><p> 需要特别说明的是，笔者这个步骤失败了多次，都是<code>app-from-source-00001</code>初始化过程意外退出。通过<code>kubectl describe</code>查看详细信息，提示构建超时（默认构建超时是10分钟）。构建过程需要拉取一些镜像，推测可能由于网络原因，该步骤耗时过长。可以在构建过程中，通过<code>kubectl describe po app-from-source-00001-zhddx</code>查看相关 Event，找到构建具体是在哪一步耗时过长。笔者最后多试几次成功了:)</p></li><li><p>当你看到 deployment pod 变为<code>Running</code>状态时，<code>Ctrl+C</code>退出观察。此时你的容器已经完成构建和部署了！</p></li><li><p>要检查服务的状态，可以</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get ksvc app-from-source --output yaml</span><br></pre></td></tr></tbody></table></figure></li><li><p>当你创建服务时，Knative 随即执行以下步骤：</p><ul><li>从 GitHub 拉取<code>revision</code>指定的代码并构建到容器中</li><li>将容器推送到 Docker Hub</li><li>为当前应用的版本创建一个新的不可变的<code>revision</code></li><li>通过网络编程为你的应用创建<code>route</code>、<code>ingress</code>、<code>service</code>和负载均衡服务</li><li>自动伸缩你的 pods（包括缩至0个活动 pods）</li></ul></li><li><p>要获取你的集群的入口 IP，使用如下命令。如果你的集群是新建的，服务获取一个外部 IP 地址可能会花一些时间：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># In Knative 0.2.x and prior versions, the `knative-ingressgateway` service was used instead of `istio-ingressgateway`.</span></span><br><span class="line">INGRESSGATEWAY=knative-ingressgateway</span><br><span class="line"></span><br><span class="line"><span class="comment"># The use of `knative-ingressgateway` is deprecated in Knative v0.3.x.</span></span><br><span class="line"><span class="comment"># Use `istio-ingressgateway` instead, since `knative-ingressgateway`</span></span><br><span class="line"><span class="comment"># will be removed in Knative v0.4.</span></span><br><span class="line"><span class="keyword">if</span> kubectl get configmap config-istio -n knative-serving &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">    INGRESSGATEWAY=istio-ingressgateway</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">kubectl get svc <span class="variable">$INGRESSGATEWAY</span> --namespace istio-system</span><br></pre></td></tr></tbody></table></figure><p> 需要注意的是，minikube 搭建的集群通过上面的方式是获取不到外部 IP 的。应该执行：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> $(minikube ip):$(kubectl get svc <span class="variable">$INGRESSGATEWAY</span> --namespace istio-system --output <span class="string">'jsonpath={.spec.ports[?(@.port==80)].nodePort}'</span>)</span><br></pre></td></tr></tbody></table></figure></li><li><p>要找到服务的 URL，输入：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get ksvc app-from-source  --output=custom-columns=NAME:.metadata.name,DOMAIN:.status.domain</span><br></pre></td></tr></tbody></table></figure></li><li><p>现在你可以向你的应用发送一个请求来看看结果。将<code>{IP_ADDRESS}</code>替换为你上一步获得的地址：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H <span class="string">"Host: app-from-source.default.example.com"</span> http://{IP_ADDRESS}</span><br></pre></td></tr></tbody></table></figure></li></ol><h2 id="清理示例应用部署"><a href="#清理示例应用部署" class="headerlink" title="清理示例应用部署"></a>清理示例应用部署</h2><p>要从你的集群移除示例应用，删除服务记录：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f service.yaml</span><br></pre></td></tr></tbody></table></figure></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/kubernetes/" rel="tag"># kubernetes</a> <a href="/tags/serverless/" rel="tag"># serverless</a></div><div class="post-nav"><div class="post-nav-item"><a href="/%E5%BC%80%E5%8F%91/57c40a44.html" rel="prev" title="Kubernetes 国外镜像的网络问题"><i class="fa fa-chevron-left"></i> Kubernetes 国外镜像的网络问题</a></div><div class="post-nav-item"> <a href="/%E5%91%A8%E6%8A%A5/57c40a44.html" rel="next" title="Serverless 每周小报-20190415">Serverless 每周小报-20190415<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E9%9C%80%E6%B1%82"><span class="nav-number">1.</span> <span class="nav-text">环境需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-Knative"><span class="nav-number">2.</span> <span class="nav-text">配置 Knative</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-kaniko-%E6%9E%84%E5%BB%BA%E6%A8%A1%E6%9D%BF"><span class="nav-number">2.1.</span> <span class="nav-text">安装 kaniko 构建模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A1%AB%E5%86%99-Docker-Hub-%E7%9A%84%E5%AF%86%E9%92%A5"><span class="nav-number">2.2.</span> <span class="nav-text">填写 Docker Hub 的密钥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E7%A4%BA%E4%BE%8B"><span class="nav-number">3.</span> <span class="nav-text">部署示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%85%E7%90%86%E7%A4%BA%E4%BE%8B%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2"><span class="nav-number">4.</span> <span class="nav-text">清理示例应用部署</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="moeyui" src="/images/blogAvatar.jpg"><p class="site-author-name" itemprop="name">moeyui</p><div class="site-description" itemprop="description">moeyui | moeyui's blog</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">40</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">7</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">37</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/moeyui1" title="GitHub → https://github.com/moeyui1" rel="noopener" target="_blank"><i class="github fa-fw"></i> GitHub</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> © 2015 – <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa-user"></i></span> <span class="author" itemprop="copyrightHolder">moeyui</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> &amp; <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div></div></footer></div><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script><script src="/bundle.js"></script><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  };(function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();;NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'Nk9tNzbllEl79DVtRiOuLmbm-gzGzoHsz',
      appKey     : 'uPzxSfSzF95Gav6vGx2dOhCq',
      placeholder: "Just go go",
      avatar     : 'retro',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});</script></body></html>