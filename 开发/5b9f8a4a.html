<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/images/logo.svg" color="#222"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"moeyui1.github.io",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!0,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="原文链接：https://medium.com/@dnivra26/microservices-monitoring-with-envoy-service-mesh-prometheus-grafana-a1c26a8595fc  如果你刚接触“Service Mesh“和“Envoy”，我这里有一篇文章可以帮你入门。 这是Envoy service mesh下的可观测性系列的第二篇文章，你可以"><meta property="og:type" content="article"><meta property="og:title" content="Envoy service mesh、Prometheus和Grafana下的微服务监控（翻译）"><meta property="og:url" content="http://moeyui1.github.io/%E5%BC%80%E5%8F%91/5b9f8a4a.html"><meta property="og:site_name" content="不是很懂"><meta property="og:description" content="原文链接：https://medium.com/@dnivra26/microservices-monitoring-with-envoy-service-mesh-prometheus-grafana-a1c26a8595fc  如果你刚接触“Service Mesh“和“Envoy”，我这里有一篇文章可以帮你入门。 这是Envoy service mesh下的可观测性系列的第二篇文章，你可以"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://ws1.sinaimg.cn/large/006tNbRwgy1fwx6wg1dscj30m90cg0sy.jpg"><meta property="og:image" content="https://ws3.sinaimg.cn/large/006tNbRwgy1fwxf9t7t5bj318g0azgof.jpg"><meta property="og:image" content="https://ws2.sinaimg.cn/large/006tNbRwgy1fwy55z3klmj31jk0f6gmd.jpg"><meta property="og:image" content="https://ws4.sinaimg.cn/large/006tNbRwgy1fwy5occy0pj31jk0gbjs6.jpg"><meta property="og:image" content="https://ws4.sinaimg.cn/large/006tNbRwly1fx6n732mrdj31jk0h7jsc.jpg"><meta property="article:published_time" content="2018-11-25T11:05:34.000Z"><meta property="article:modified_time" content="2021-02-08T10:12:18.754Z"><meta property="article:author" content="moeyui"><meta property="article:tag" content="service mesh"><meta property="article:tag" content="Envoy"><meta property="article:tag" content="翻译"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://ws1.sinaimg.cn/large/006tNbRwgy1fwx6wg1dscj30m90cg0sy.jpg"><link rel="canonical" href="http://moeyui1.github.io/%E5%BC%80%E5%8F%91/5b9f8a4a.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>Envoy service mesh、Prometheus和Grafana下的微服务监控（翻译） | 不是很懂</title><script>function sendPageView(){if(CONFIG.hostname===location.hostname){var e=localStorage.getItem("uid")||Math.random()+"."+Math.random();localStorage.setItem("uid",e),navigator.sendBeacon("https://www.google-analytics.com/collect",new URLSearchParams({v:1,tid:"UA-75483578-1",cid:e,t:"pageview",dp:encodeURIComponent(location.pathname)}))}}document.addEventListener("pjax:complete",sendPageView),sendPageView()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><script>function loadCss(e){var n=document,s=n.head,t=n.createElement("link");t.rel="stylesheet",t.href=e,function e(s){if(n.body)return s();setTimeout(function(){e(s)})}(function(){s.appendChild(t)})}loadCss("/style.css"),loadCss("//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"),loadCss("//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css")</script><noscript><link rel="stylesheet" href="/style.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"></noscript></head><body itemscope="" itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">不是很懂</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">不是很懂你们程序员</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> 首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> 归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i> 分类</a></li></ul></nav></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/moeyui1" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://moeyui1.github.io/%E5%BC%80%E5%8F%91/5b9f8a4a.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/blogAvatar.jpg"><meta itemprop="name" content="moeyui"><meta itemprop="description" content="moeyui | moeyui's blog"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="不是很懂"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Envoy service mesh、Prometheus和Grafana下的微服务监控（翻译）</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-11-25 19:05:34" itemprop="dateCreated datePublished" datetime="2018-11-25T19:05:34+08:00">2018-11-25</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-02-08 18:12:18" itemprop="dateModified" datetime="2021-02-08T18:12:18+08:00">2021-02-08</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a></span></span><span id="/%E5%BC%80%E5%8F%91/5b9f8a4a.html" class="post-meta-item leancloud_visitors" data-flag-title="Envoy service mesh、Prometheus和Grafana下的微服务监控（翻译）" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Valine：</span><a title="valine" href="/%E5%BC%80%E5%8F%91/5b9f8a4a.html#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/%E5%BC%80%E5%8F%91/5b9f8a4a.html" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>原文链接：<a target="_blank" rel="noopener" href="https://medium.com/@dnivra26/microservices-monitoring-with-envoy-service-mesh-prometheus-grafana-a1c26a8595fc">https://medium.com/@dnivra26/microservices-monitoring-with-envoy-service-mesh-prometheus-grafana-a1c26a8595fc</a></p></blockquote><p>如果你刚接触“Service Mesh“和“Envoy”，我<a target="_blank" rel="noopener" href="https://medium.com/@dnivra26/service-mesh-with-envoy-101-e6b2131ee30b">这里</a>有一篇文章可以帮你入门。</p><p>这是<strong>Envoy service mesh下的可观测性</strong>系列的第二篇文章，你可以在<a target="_blank" rel="noopener" href="https://medium.com/@dnivra26/distributed-tracing-with-envoy-service-mesh-jaeger-c365b6191592">这里</a>阅读第一篇关于分布式追踪的文章。</p><p>在微服务中谈及监控时，你可不能被蒙在鼓里，至少要知道问题出在哪儿了。</p><p>让我们看看Envoy是怎样帮助我们了解我们的服务运行状况的。在service mesh下，所有的通信都会通过mesh，这意味着没有任何服务会与其它服务直接通信，服务向Envoy发起调用请求，然后Envoy将调用请求路由到目标服务，所以Envoy将持有传入和传出流量的上下文。Envoy通常提供关于<a target="_blank" rel="noopener" href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http_conn_man/stats">传入</a>请求、<a target="_blank" rel="noopener" href="https://www.envoyproxy.io/docs/envoy/latest/configuration/cluster_manager/cluster_stats">传出</a>请求和<a target="_blank" rel="noopener" href="https://www.envoyproxy.io/docs/envoy/latest/configuration/statistics">Envoy实例状态</a>的指标。</p><span id="more"></span><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>这是我们将要构建的系统概览。</p><p><img data-src="https://ws1.sinaimg.cn/large/006tNbRwgy1fwx6wg1dscj30m90cg0sy.jpg" alt="overall setup"></p><h2 id="Statsd"><a href="#Statsd" class="headerlink" title="Statsd"></a>Statsd</h2><p>Envoy支持通过两到三种格式来暴露指标，但本文中我们将使用<a target="_blank" rel="noopener" href="https://github.com/b/statsd_spec">statsd</a>格式。</p><p>所以流程将是这样，首先Envoy推送指标到statsd，然后我们用<a target="_blank" rel="noopener" href="https://github.com/prometheus">prometheus</a>（一个时序数据库）从statsd拉取指标，最后通过<a target="_blank" rel="noopener" href="https://github.com/grafana/grafana">grafana</a>可视化这些指标。</p><p>在准备概览图中，我提到了statsd exporter而不是statsd，这是因为我们并不会直接使用statsd，而是使用一个接收statsd格式数据，并将其以prometheus格式输出的转换器（服务）。下面让我们来搞定它吧。</p><p>Envoy的指标主要分为两类：</p><ol><li>Counter（计数器）：一个只增不减的指标。如：请求总数</li><li>Gauge（量表）：一个可增可减的指标，类似于一个瞬时值。如：当前CPU使用量</li></ol><p>让我们看一个包含stats sink的Envoy配置</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">admin:</span></span><br><span class="line">  <span class="attr">access_log_path:</span> <span class="string">"/tmp/admin_access.log"</span></span><br><span class="line">  <span class="attr">address:</span> </span><br><span class="line">    <span class="attr">socket_address:</span> </span><br><span class="line">      <span class="attr">address:</span> <span class="string">"127.0.0.1"</span></span><br><span class="line">      <span class="attr">port_value:</span> <span class="number">9901</span></span><br><span class="line"><span class="attr">stats_sinks:</span></span><br><span class="line">  <span class="bullet">-</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">"envoy.statsd"</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">tcp_cluster_name:</span> <span class="string">"statsd-exporter"</span></span><br><span class="line">      <span class="attr">prefix:</span> <span class="string">front-envoy</span>    </span><br><span class="line"><span class="attr">static_resources:</span> </span><br><span class="line">  <span class="attr">listeners:</span></span><br><span class="line">    <span class="bullet">-</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">"http_listener"</span></span><br><span class="line">      <span class="attr">address:</span> </span><br><span class="line">        <span class="attr">socket_address:</span> </span><br><span class="line">          <span class="attr">address:</span> <span class="string">"0.0.0.0"</span></span><br><span class="line">          <span class="attr">port_value:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">filter_chains:</span></span><br><span class="line">          <span class="attr">filters:</span> </span><br><span class="line">            <span class="bullet">-</span> </span><br><span class="line">              <span class="attr">name:</span> <span class="string">"envoy.http_connection_manager"</span></span><br><span class="line">              <span class="attr">config:</span></span><br><span class="line">                <span class="attr">use_remote_address:</span> <span class="literal">true</span></span><br><span class="line">                <span class="attr">add_user_agent:</span> <span class="literal">true</span></span><br><span class="line">                <span class="attr">access_log:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">envoy.file_access_log</span></span><br><span class="line">                  <span class="attr">config:</span></span><br><span class="line">                    <span class="attr">path:</span> <span class="string">/dev/stdout</span></span><br><span class="line">                    <span class="attr">format:</span> <span class="string">"[ACCESS_LOG][%START_TIME%] \"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\" %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \"%REQ(X-FORWARDED-FOR)%\" \"%REQ(USER-AGENT)%\" \"%REQ(X-REQUEST-ID)%\" \"%REQ(:AUTHORITY)%\" \"%UPSTREAM_HOST%\" \"%DOWNSTREAM_REMOTE_ADDRESS_WITHOUT_PORT%\"\n"</span></span><br><span class="line">                <span class="attr">stat_prefix:</span> <span class="string">"ingress_443"</span></span><br><span class="line">                <span class="attr">codec_type:</span> <span class="string">"AUTO"</span></span><br><span class="line">                <span class="attr">generate_request_id:</span> <span class="literal">true</span></span><br><span class="line">                <span class="attr">route_config:</span> </span><br><span class="line">                  <span class="attr">name:</span> <span class="string">"local_route"</span></span><br><span class="line">                  <span class="attr">virtual_hosts:</span> </span><br><span class="line">                    <span class="bullet">-</span> </span><br><span class="line">                      <span class="attr">name:</span> <span class="string">"http-route"</span></span><br><span class="line">                      <span class="attr">domains:</span> </span><br><span class="line">                        <span class="bullet">-</span> <span class="string">"*"</span></span><br><span class="line">                      <span class="attr">routes:</span> </span><br><span class="line">                        <span class="bullet">-</span> </span><br><span class="line">                          <span class="attr">match:</span> </span><br><span class="line">                            <span class="attr">prefix:</span> <span class="string">"/"</span></span><br><span class="line">                          <span class="attr">route:</span></span><br><span class="line">                            <span class="attr">cluster:</span> <span class="string">"service_a"</span></span><br><span class="line">                <span class="attr">http_filters:</span></span><br><span class="line">                  <span class="bullet">-</span> </span><br><span class="line">                    <span class="attr">name:</span> <span class="string">"envoy.router"</span></span><br><span class="line">  <span class="attr">clusters:</span></span><br><span class="line">    <span class="bullet">-</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">"statsd"</span></span><br><span class="line">      <span class="attr">connect_timeout:</span> <span class="string">"0.25s"</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">"strict_dns"</span></span><br><span class="line">      <span class="attr">lb_policy:</span> <span class="string">"ROUND_ROBIN"</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span></span><br><span class="line">          <span class="attr">socket_address:</span></span><br><span class="line">            <span class="attr">address:</span> <span class="string">"statsd_exporter"</span></span><br><span class="line">            <span class="attr">port_value:</span> <span class="number">9125</span></span><br><span class="line">    <span class="bullet">-</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">"service_a"</span></span><br><span class="line">      <span class="attr">connect_timeout:</span> <span class="string">"0.25s"</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">"strict_dns"</span></span><br><span class="line">      <span class="attr">lb_policy:</span> <span class="string">"ROUND_ROBIN"</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> </span><br><span class="line">          <span class="attr">socket_address:</span> </span><br><span class="line">            <span class="attr">address:</span> <span class="string">"service_a_envoy"</span></span><br><span class="line">            <span class="attr">port_value:</span> <span class="number">8786</span></span><br></pre></td></tr></tbody></table></figure><p>第8-13行告诉Envoy我们需要statsd格式的指标、我们的统计信息前缀（通常是你的服务名）是什么和statsd sink的地址。</p><p>第55-63行配置了我们的环境中的statsd sink。</p><p>这就是让Envoy输出统计信息所需要的所有配置。现在让我们来看看第2-7行做了哪些事情：</p><ol><li>Envoy在9901端口暴露了一个管理端，你可以通过它动态地改变日志级别，查看当前配置、统计数据等</li><li>Envoy也可以生成与nginx类似的访问日志，你可以通过它了解服务间的通信状况。访问日志的格式也是可配置的，如第29-33行</li></ol><p>你需要将相同的配置添加到系统中的其它Envoy sidecar上（是的，每个服务都有自己的Envoy sidecar）。</p><p>这些服务本身是用go写的，它们做的事情很简单，仅仅是通过Envoy调用其它服务。你可以在<a target="_blank" rel="noopener" href="https://github.com/dnivra26/envoy_monitoring">这里</a>查看服务和Envoy的配置。</p><p>现在，虽然我们只有图中的statsd exporter，但有了它，如果我们运行docker容器（docker-compose build &amp; docker-compose up），然后向Front Envoy（localhost:8080）发送一些流量，Envoy 将把这些流量的指标发送到statsd exporter，随后statsd exporter会把这些指标转换成prometheus格式，并将其暴露在9102端口。</p><p>Statsd exporter中的统计信息格式如下图所示</p><p><img data-src="https://ws3.sinaimg.cn/large/006tNbRwgy1fwxf9t7t5bj318g0azgof.jpg" alt="来自statsd exporter的prometheus格式的指标"></p><p>这里边将有上百个指标，同时，在上面的截图中我们能看到Service A和Service B之间的通信延迟指标。上图的指标是遵循prometheus格式的</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">metric_name ["{" label_name "=" `"` label_value `"` { "," label_name "=" `"` label_value `"` } [ "," ] "}"] value [ timestamp ]</span><br></pre></td></tr></tbody></table></figure><p>你可以在<a target="_blank" rel="noopener" href="https://github.com/prometheus/docs/blob/master/content/docs/instrumenting/exposition_formats.md">这里</a>了解更多。</p><h2 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h2><p>我们将使用<a target="_blank" rel="noopener" href="https://prometheus.io/">Prometheus</a>作为时序数据库来保存我们的指标。Prometheus不仅是一个时序数据库，它本身还是一个监控系统，但本文我们只用它来存储指标数据。需要注意的是，prometheus是一个通过主动拉取来获取指标的系统，这意味着你必须告诉prometheus从何处拉取指标，在我们的例子中是从statsd exporter处拉取。</p><p>将Prometheus添加到系统中非常简单而又直接，我们只需要将拉取目标（statsd exporter）作为配置文件传递给Prometheus就可以了。配置看起来是这样的</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>  <span class="string">15s</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'statsd'</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">'statsd_exporter:9102'</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">'services'</span></span><br></pre></td></tr></tbody></table></figure><p>scrape_interval的值表示Prometheus从目标处拉取配置的频率。</p><p>现在启动Prometheus，里面应该有一些数据了。让我们打开localhost:9090来看一看</p><p><img data-src="https://ws2.sinaimg.cn/large/006tNbRwgy1fwy55z3klmj31jk0f6gmd.jpg" alt="prometheus查询页面"></p><p>如图所示，可以看到我们的指标。你能做的可不仅仅是选择已有的指标，从<a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/querying/basics/">这里</a>可以阅读关于prometheus查询语言的更多信息。它还可以基于查询结果绘制图表，除此之外还有一个报警系统。</p><p>如果我们打开prometheus的targets页面，将能看到所有的拉取目标和它们的健康状态</p><p><img data-src="https://ws4.sinaimg.cn/large/006tNbRwgy1fwy5occy0pj31jk0gbjs6.jpg" alt="prometheus目标"></p><h2 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h2><p>Grafana是一个很棒的监控可视化解决方案，它支持Prometheus，Graphite，InfluxDB，ElasticSearch等多种后端。</p><p>Grafana有两大主要组件需要我们配置</p><ol><li><p>数据源（Datasource）：指定grafana从哪个后端获取指标。你可以通过配置文件来配置数据源，代码如下所示</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">datasources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">access:</span> <span class="string">Server</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">http://prometheus:9090</span></span><br><span class="line">    <span class="attr">editable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">isDefault:</span></span><br></pre></td></tr></tbody></table></figure></li><li><p>仪表盘（Dashboard）：你可以从仪表盘查看来自数据源的指标。Grafana支持多种可视化元素，如Graphs，Single Stats，Heatmaps……你可以继承这些元素并使用插件来构造自己的元素。</p></li></ol><p>我在使用Grafana时遇到的唯一一个问题是，缺少一种标准的方法来用代码开发那些仪表盘。所幸有一些第三方的库提供了支持，我们将使用来自weaveworks的<a target="_blank" rel="noopener" href="https://github.com/weaveworks/grafanalib">grafanalib</a>。</p><p>下面是我们通过 python 代码尝试构建的一个仪表盘</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> grafanalib.core <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">dashboard = Dashboard(</span><br><span class="line">    title=<span class="string">"Services Dashboard"</span>,</span><br><span class="line">    templating=Templating(</span><br><span class="line">        [</span><br><span class="line">            Template(</span><br><span class="line">                name=<span class="string">"source"</span>,</span><br><span class="line">                dataSource=<span class="string">"prometheus"</span>,</span><br><span class="line">                query=<span class="string">"metrics(.*_cluster_.*_upstream_rq_2xx)"</span>,</span><br><span class="line">                regex=<span class="string">"/(.*)_cluster_.*_upstream_rq_2xx/"</span>,</span><br><span class="line">                default=<span class="string">"service_a"</span></span><br><span class="line">            ),</span><br><span class="line">            Template(</span><br><span class="line">                name=<span class="string">"destination"</span>,</span><br><span class="line">                dataSource=<span class="string">"prometheus"</span>,</span><br><span class="line">                query=<span class="string">"metrics(.*_cluster_.*_upstream_rq_2xx)"</span>,</span><br><span class="line">                regex=<span class="string">"/.*_cluster_(.*)_upstream_rq_2xx/"</span>,</span><br><span class="line">                default=<span class="string">"service_b"</span></span><br><span class="line">            )</span><br><span class="line">        ]</span><br><span class="line">    ),</span><br><span class="line">    rows=[</span><br><span class="line">        Row(</span><br><span class="line">            panels=[</span><br><span class="line">                Graph(</span><br><span class="line">                    title=<span class="string">"2XX"</span>,</span><br><span class="line">                    transparent=<span class="literal">True</span>,</span><br><span class="line">                    dataSource=<span class="string">"prometheus"</span>,</span><br><span class="line">                    targets=[</span><br><span class="line">                        Target(</span><br><span class="line">                            expr=<span class="string">"[[source]]_cluster_[[destination]]_upstream_rq_2xx - [[source]]_cluster_[[destination]]_upstream_rq_2xx offset $__interval"</span>,</span><br><span class="line">                            legendFormat=<span class="string">"2xx"</span></span><br><span class="line">                        )</span><br><span class="line">                    ]</span><br><span class="line">                ),</span><br><span class="line">                Graph(</span><br><span class="line">                    title=<span class="string">"5XX"</span>,</span><br><span class="line">                    transparent=<span class="literal">True</span>,</span><br><span class="line">                    dataSource=<span class="string">"prometheus"</span>,</span><br><span class="line">                    targets=[</span><br><span class="line">                        Target(</span><br><span class="line">                            expr=<span class="string">"[[source]]_cluster_[[destination]]_upstream_rq_5xx - [[source]]_cluster_[[destination]]_upstream_rq_5xx offset $__interval"</span>,</span><br><span class="line">                            legendFormat=<span class="string">"5xx"</span></span><br><span class="line">                        ),</span><br><span class="line">                    ]</span><br><span class="line">                ),</span><br><span class="line">                Graph(</span><br><span class="line">                    title=<span class="string">"Latency"</span>,</span><br><span class="line">                    transparent=<span class="literal">True</span>,</span><br><span class="line">                    dataSource=<span class="string">"prometheus"</span>,</span><br><span class="line">                    targets=[</span><br><span class="line">                        Target(</span><br><span class="line">                            expr=<span class="string">"[[source]]_cluster_[[destination]]_upstream_rq_time"</span>,</span><br><span class="line">                            legendFormat=<span class="string">"{{quantile}}"</span></span><br><span class="line">                        )</span><br><span class="line">                    ]</span><br><span class="line">                )</span><br><span class="line">            ]</span><br><span class="line">        ),</span><br><span class="line">    ]</span><br><span class="line">).auto_panel_ids()</span><br></pre></td></tr></tbody></table></figure><p>在这段代码中，我们为2xx，5xx和延迟数据构建了图表。其中第5-22行很重要，它从我们的设置中提取可用的service names作为grafana的变量，为我们创建一个动态的仪表盘，这意味着我们能够选择性地查看特定源服务和目标服务的统计数据。如果想了解更多关于变量的内容请参考<a target="_blank" rel="noopener" href="http://docs.grafana.org/reference/templating/">这里</a>。</p><p>你需要通过grafanalib命令来从上述python文件生成仪表盘</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">generate-dashboard -o dashboard.json service-dashboard.py</span><br></pre></td></tr></tbody></table></figure><p>注意这里生成的dashboard.json可不容易阅读。</p><p>所以，启动Grafana时我们只需要传递仪表盘和数据源就好了。当访问http:localhost:3000时，你将看到：</p><p><img data-src="https://ws4.sinaimg.cn/large/006tNbRwly1fx6n732mrdj31jk0h7jsc.jpg" alt="grafana仪表盘"></p><p>现在你应该能看到2xx，5xx和延迟的图表，同时还能看到一个下拉菜单，你可以通过它选择源服务和目标服务。关于Grafana还有许多内容我们没有讨论到，包括强大的查询编辑器和告警系统。更重要的是，这一切都是可以通过插件和应用扩展的，可以参考<a target="_blank" rel="noopener" href="https://github.com/grafana/kubernetes-app">这里</a>的例子。如果你正想可视化常见服务如redis，rabbitmq等的指标，grafana有一个<a target="_blank" rel="noopener" href="https://grafana.com/dashboards">公共仪表盘</a>库，你只需要导入它们就可以使用了。使用Grafana 还有一个好处，你可以通过配置文件和代码创建和管理所有东西，而不需要过多地通过UI来操作。</p><p>我建议你试用一下prometheus和grafana以了解更多信息。感谢阅读，如有建议和意见，请写在评论中。</p><p>在<a target="_blank" rel="noopener" href="https://github.com/dnivra26/envoy_monitoring/">这里</a>可以找到所有代码和配置文件。</p></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/service-mesh/" rel="tag"># service mesh</a> <a href="/tags/Envoy/" rel="tag"># Envoy</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" rel="tag"># 翻译</a></div><div class="post-nav"><div class="post-nav-item"><a href="/%E5%BC%80%E5%8F%91/d1717587.html" rel="prev" title="gRPC Bidirectional（双向流）源码分析"><i class="fa fa-chevron-left"></i> gRPC Bidirectional（双向流）源码分析</a></div><div class="post-nav-item"> <a href="/%E5%BC%80%E5%8F%91/c193b63f.html" rel="next" title="Envoy 热重启实践">Envoy 热重启实践<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87"><span class="nav-number">1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Statsd"><span class="nav-number">2.</span> <span class="nav-text">Statsd</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Prometheus"><span class="nav-number">3.</span> <span class="nav-text">Prometheus</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Grafana"><span class="nav-number">4.</span> <span class="nav-text">Grafana</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="moeyui" src="/images/blogAvatar.jpg"><p class="site-author-name" itemprop="name">moeyui</p><div class="site-description" itemprop="description">moeyui | moeyui's blog</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">40</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">7</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">37</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/moeyui1" title="GitHub → https://github.com/moeyui1" rel="noopener" target="_blank"><i class="github fa-fw"></i> GitHub</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> © 2015 – <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa-user"></i></span> <span class="author" itemprop="copyrightHolder">moeyui</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> &amp; <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div></div></footer></div><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script><script src="/bundle.js"></script><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  };(function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();;NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'Nk9tNzbllEl79DVtRiOuLmbm-gzGzoHsz',
      appKey     : 'uPzxSfSzF95Gav6vGx2dOhCq',
      placeholder: "Just go go",
      avatar     : 'retro',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});</script></body></html>