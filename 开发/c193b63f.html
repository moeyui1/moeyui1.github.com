<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/images/logo.svg" color="#222"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"moeyui1.github.io",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!0,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="Envoy 支持热重启，本文主要介绍热重启的实践和官方热重启包装器的使用"><meta property="og:type" content="article"><meta property="og:title" content="Envoy 热重启实践"><meta property="og:url" content="http://moeyui1.github.io/%E5%BC%80%E5%8F%91/c193b63f.html"><meta property="og:site_name" content="不是很懂"><meta property="og:description" content="Envoy 支持热重启，本文主要介绍热重启的实践和官方热重启包装器的使用"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2019-01-29T13:02:31.000Z"><meta property="article:modified_time" content="2021-02-08T10:12:18.751Z"><meta property="article:author" content="moeyui"><meta property="article:tag" content="envoy"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://moeyui1.github.io/%E5%BC%80%E5%8F%91/c193b63f.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>Envoy 热重启实践 | 不是很懂</title><script>function sendPageView(){if(CONFIG.hostname===location.hostname){var e=localStorage.getItem("uid")||Math.random()+"."+Math.random();localStorage.setItem("uid",e),navigator.sendBeacon("https://www.google-analytics.com/collect",new URLSearchParams({v:1,tid:"UA-75483578-1",cid:e,t:"pageview",dp:encodeURIComponent(location.pathname)}))}}document.addEventListener("pjax:complete",sendPageView),sendPageView()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><script>function loadCss(e){var n=document,s=n.head,t=n.createElement("link");t.rel="stylesheet",t.href=e,function e(s){if(n.body)return s();setTimeout(function(){e(s)})}(function(){s.appendChild(t)})}loadCss("/style.css"),loadCss("//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"),loadCss("//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css")</script><noscript><link rel="stylesheet" href="/style.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"></noscript></head><body itemscope="" itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">不是很懂</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">不是很懂你们程序员</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> 首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> 归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i> 分类</a></li></ul></nav></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/moeyui1" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://moeyui1.github.io/%E5%BC%80%E5%8F%91/c193b63f.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/blogAvatar.jpg"><meta itemprop="name" content="moeyui"><meta itemprop="description" content="moeyui | moeyui's blog"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="不是很懂"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Envoy 热重启实践</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-01-29 21:02:31" itemprop="dateCreated datePublished" datetime="2019-01-29T21:02:31+08:00">2019-01-29</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-02-08 18:12:18" itemprop="dateModified" datetime="2021-02-08T18:12:18+08:00">2021-02-08</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a></span></span><span id="/%E5%BC%80%E5%8F%91/c193b63f.html" class="post-meta-item leancloud_visitors" data-flag-title="Envoy 热重启实践" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Valine：</span><a title="valine" href="/%E5%BC%80%E5%8F%91/c193b63f.html#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/%E5%BC%80%E5%8F%91/c193b63f.html" itemprop="commentCount"></span></a></span><div class="post-description">Envoy 支持热重启，本文主要介绍热重启的实践和官方热重启包装器的使用</div></div></header><div class="post-body" itemprop="articleBody"><p><a target="_blank" rel="noopener" href="https://www.envoyproxy.io/">Envoy</a> 是一个高性能的开源服务代理。本文主要介绍热重启的实践和官方热重启包装器的使用。</p><p>Envoy 支持热重启，并且为了兼容进程管理器（例如 monit、runit 等）提供了一个 Python 写的热重启包装器 <code>restart/hot-restarter.py</code>。</p><p>但是官方文档讲得不是很清楚，一开始误解了包装器的使用方式，疯狂碰壁。。。</p><h1 id="手动热重启"><a href="#手动热重启" class="headerlink" title="手动热重启"></a>手动热重启</h1><p>如果不使用包装器，手动热重启时，需要在新进程启动参数中添加 –restart-epoch x ，x表示重启纪元，按1递增。不传默认为0，故第一次启动可以不传。</p><blockquote><p>restart epoch 应该按1递增，因为在 Envoy 源码中，会按照 epoch -1 计算和 epoch +1 计算 parent address 和 child address</p></blockquote><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">HotRestartImpl::<span class="built_in">HotRestartImpl</span>(Options&amp; options)</span><br><span class="line">    : <span class="built_in">options_</span>(options), <span class="built_in">stats_set_options_</span>(<span class="built_in">blockMemHashOptions</span>(options.<span class="built_in">maxStats</span>())),</span><br><span class="line">      <span class="built_in">shmem_</span>(SharedMemory::<span class="built_in">initialize</span>(</span><br><span class="line">          RawStatDataSet::<span class="built_in">numBytes</span>(stats_set_options_, options_.<span class="built_in">statsOptions</span>()), options_)),</span><br><span class="line">      <span class="built_in">log_lock_</span>(shmem_.log_lock_), <span class="built_in">access_log_lock_</span>(shmem_.access_log_lock_),</span><br><span class="line">      <span class="built_in">stat_lock_</span>(shmem_.stat_lock_), <span class="built_in">init_lock_</span>(shmem_.init_lock_) {</span><br><span class="line">  {</span><br><span class="line">    <span class="comment">// We must hold the stat lock when attaching to an existing memory segment</span></span><br><span class="line">    <span class="comment">// because it might be actively written to while we sanityCheck it.</span></span><br><span class="line">    <span class="function">Thread::LockGuard <span class="title">lock</span><span class="params">(stat_lock_)</span></span>;</span><br><span class="line">    stats_set_.<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">RawStatDataSet</span>(stats_set_options_, options.<span class="built_in">restartEpoch</span>() == <span class="number">0</span>,</span><br><span class="line">                                        shmem_.stats_set_data_, options_.<span class="built_in">statsOptions</span>()));</span><br><span class="line">  }</span><br><span class="line">  my_domain_socket_ = <span class="built_in">bindDomainSocket</span>(options.<span class="built_in">restartEpoch</span>());</span><br><span class="line">  <span class="comment">// 这里计算 child address</span></span><br><span class="line">  child_address_ = <span class="built_in">createDomainSocketAddress</span>((options.<span class="built_in">restartEpoch</span>() + <span class="number">1</span>));</span><br><span class="line">  <span class="built_in">initDomainSocketAddress</span>(&amp;parent_address_);</span><br><span class="line">  <span class="keyword">if</span> (options.<span class="built_in">restartEpoch</span>() != <span class="number">0</span>) {</span><br><span class="line">    <span class="comment">// 这里计算 parent address</span></span><br><span class="line">    parent_address_ = <span class="built_in">createDomainSocketAddress</span>((options.<span class="built_in">restartEpoch</span>() + <span class="number">-1</span>));</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If our parent ever goes away just terminate us so that we don't have to rely on ops/launching</span></span><br><span class="line">  <span class="comment">// logic killing the entire process tree. We should never exist without our parent.</span></span><br><span class="line">  <span class="keyword">int</span> rc = <span class="built_in">prctl</span>(PR_SET_PDEATHSIG, SIGTERM);</span><br><span class="line">  <span class="built_in">RELEASE_ASSERT</span>(rc != <span class="number">-1</span>, <span class="string">""</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h1 id="包装器热重启"><a href="#包装器热重启" class="headerlink" title="包装器热重启"></a>包装器热重启</h1><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>为了兼容各种进程管理，最好是用包装器将 Envoy 管理起来。这里主要介绍官方的 Python 包装器。</p><p>使用包装器即把 Envoy 的生命周期管理委托给包装器， <a target="_blank" rel="noopener" href="https://istio.io/">Istio</a> 中的 <a target="_blank" rel="noopener" href="https://istio.io/docs/concepts/what-is-istio/#pilot">Pilot-agent</a> 也是这样做的。启动时应启动包装器：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python restart/hot-restarter.py start_envoy.sh</span><br></pre></td></tr></tbody></table></figure><p>其中 start_envoy.sh 为用户自定义的启动脚本，包装器会在每次热重启时调用这个脚本。可以这么写：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">exec</span> /code/envoy-bin/envoy  -c /code/envoy.yaml --restart-epoch <span class="variable">$RESTART_EPOCH</span> </span><br></pre></td></tr></tbody></table></figure><p>其中 <code>--restart-epoch $RESTART_EPOCH</code> 参数是必要的，而 <code>$RESTART_EPOCH</code> 这个变量会由包装器设置，不需要用户理会。</p><p>包装器启动后就会把 Envoy 拉起来。包装器支持信号处理：</p><ul><li><p><strong>SIGTERM</strong>：将干净地终止所有子进程并退出。用于结束整个流程。</p></li><li><p><strong>SIGHUP</strong>：将重新调用作为第一个参数传递给热重启程序的脚本，来进行热重启。</p></li><li><p><strong>SIGCHLD</strong>：如果任何子进程意外关闭，那么重启脚本将关闭所有内容并退出以避免处于意外状态。随后，控制进程管理器应该重新启动重启脚本以再次启动 Envoy。这个信号通常又 Envoy 传递给包装器。</p></li><li><p><strong>SIGUSR1</strong>：将作为重新打开所有访问日志的信号，转发给 Envoy。可用于原子移动以及重新打开日志轮转。</p></li></ul><p>故使用时，可以通过向包装器发送信号来控制 Envoy 的生命周期。热重启时，可以通过 <code>kill -1 pid</code> 向包装器进程发送 <strong>sighup</strong> 信号，让其热重启。</p><h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><p>首先看 main 方法：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">  <span class="string">""" Script main. This script is designed so that a process watcher like runit or monit can watch</span></span><br><span class="line"><span class="string">      this process and take corrective action if it ever goes away. """</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"starting hot-restarter with target: {}"</span>.<span class="built_in">format</span>(sys.argv[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">  signal.signal(signal.SIGTERM, sigterm_handler)</span><br><span class="line">  signal.signal(signal.SIGHUP, sighup_handler)</span><br><span class="line">  signal.signal(signal.SIGCHLD, sigchld_handler)</span><br><span class="line">  signal.signal(signal.SIGUSR1, sigusr1_handler)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Start the first child process and then go into an endless loop since everything else happens via</span></span><br><span class="line">  <span class="comment"># signals.</span></span><br><span class="line">  fork_and_exec()</span><br><span class="line">  <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    time.sleep(<span class="number">60</span>)</span><br></pre></td></tr></tbody></table></figure><p>再看 <code>fork_and_exec</code> 方法：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ......</span></span><br><span class="line"><span class="comment"># 文件头定义了一个全局变量保存 epoch</span></span><br><span class="line">restart_epoch = <span class="number">0</span></span><br><span class="line"><span class="comment"># ......</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fork_and_exec</span>():</span></span><br><span class="line">  <span class="string">""" This routine forks and execs a new child process and keeps track of its PID. Before we fork,</span></span><br><span class="line"><span class="string">      set the current restart epoch in an env variable that processes can read if they care. """</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 引用全局变量</span></span><br><span class="line">  <span class="keyword">global</span> restart_epoch</span><br><span class="line">  <span class="comment"># 设置环境变量，主要是为了后续脚本使用</span></span><br><span class="line">  os.environ[<span class="string">'RESTART_EPOCH'</span>] = <span class="built_in">str</span>(restart_epoch)</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"forking and execing new child process at epoch {}"</span>.<span class="built_in">format</span>(restart_epoch))</span><br><span class="line">  restart_epoch += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  child_pid = os.fork()</span><br><span class="line">  <span class="keyword">if</span> child_pid == <span class="number">0</span>:</span><br><span class="line">    <span class="comment"># Child process</span></span><br><span class="line">    <span class="comment"># 执行脚本</span></span><br><span class="line">    os.execl(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">1</span>])</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># Parent process</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"forked new child process with PID={}"</span>.<span class="built_in">format</span>(child_pid))</span><br><span class="line">    <span class="comment"># 将 pid 保存起来，退出时全部 kill 掉</span></span><br><span class="line">    pid_list.append(child_pid)</span><br></pre></td></tr></tbody></table></figure><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a target="_blank" rel="noopener" href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/hot_restart.html">官方文档</a> 关于热重启；</li><li><a target="_blank" rel="noopener" href="https://blog.envoyproxy.io/envoy-hot-restart-1d16b14555b5">Envoy hot restart</a> 关于热重启设计的官方文档；</li><li><a target="_blank" rel="noopener" href="https://www.envoyproxy.io/docs/envoy/latest/operations/hot_restarter">官方文档</a> 关于热重启包装器。</li></ol></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/envoy/" rel="tag"># envoy</a></div><div class="post-nav"><div class="post-nav-item"><a href="/%E5%BC%80%E5%8F%91/5b9f8a4a.html" rel="prev" title="Envoy service mesh、Prometheus和Grafana下的微服务监控（翻译）"><i class="fa fa-chevron-left"></i> Envoy service mesh、Prometheus和Grafana下的微服务监控（翻译）</a></div><div class="post-nav-item"> <a href="/%E5%BC%80%E5%8F%91/57c40a44.html" rel="next" title="Kubernetes 国外镜像的网络问题">Kubernetes 国外镜像的网络问题<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%89%8B%E5%8A%A8%E7%83%AD%E9%87%8D%E5%90%AF"><span class="nav-number">1.</span> <span class="nav-text">手动热重启</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8C%85%E8%A3%85%E5%99%A8%E7%83%AD%E9%87%8D%E5%90%AF"><span class="nav-number">2.</span> <span class="nav-text">包装器热重启</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">2.1.</span> <span class="nav-text">使用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">4.</span> <span class="nav-text">参考</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="moeyui" src="/images/blogAvatar.jpg"><p class="site-author-name" itemprop="name">moeyui</p><div class="site-description" itemprop="description">moeyui | moeyui's blog</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">40</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">7</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">37</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/moeyui1" title="GitHub → https://github.com/moeyui1" rel="noopener" target="_blank"><i class="github fa-fw"></i> GitHub</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> © 2015 – <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa-user"></i></span> <span class="author" itemprop="copyrightHolder">moeyui</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> &amp; <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div></div></footer></div><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script><script src="/bundle.js"></script><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  };(function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();;NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'Nk9tNzbllEl79DVtRiOuLmbm-gzGzoHsz',
      appKey     : 'uPzxSfSzF95Gav6vGx2dOhCq',
      placeholder: "Just go go",
      avatar     : 'retro',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});</script></body></html>