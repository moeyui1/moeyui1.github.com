<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/images/logo.svg" color="#222"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"moeyui1.github.io",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!0,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="Pilot 是 Istio 中一个重要的组件，它主要分为 Agent 和 Discovery Services 两部分。本文着重介绍下承担 Envoy 保姆一职的 Agent。"><meta property="og:type" content="article"><meta property="og:title" content="Istio学习之Pilot-agent"><meta property="og:url" content="http://moeyui1.github.io/%E5%BC%80%E5%8F%91/760a5082.html"><meta property="og:site_name" content="不是很懂"><meta property="og:description" content="Pilot 是 Istio 中一个重要的组件，它主要分为 Agent 和 Discovery Services 两部分。本文着重介绍下承担 Envoy 保姆一职的 Agent。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://camo.githubusercontent.com/919e2e3cd8e4267a00035b813df53902864a3388/68747470733a2f2f63646e2e7261776769742e636f6d2f697374696f2f70696c6f742f6d61737465722f646f632f70696c6f742e737667"><meta property="og:image" content="https://i.loli.net/2018/09/09/5b94b1c621c56.png"><meta property="article:published_time" content="2018-09-09T06:09:06.000Z"><meta property="article:modified_time" content="2021-02-08T10:12:18.753Z"><meta property="article:author" content="moeyui"><meta property="article:tag" content="Istio"><meta property="article:tag" content="meituan"><meta property="article:tag" content="service mesh"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://camo.githubusercontent.com/919e2e3cd8e4267a00035b813df53902864a3388/68747470733a2f2f63646e2e7261776769742e636f6d2f697374696f2f70696c6f742f6d61737465722f646f632f70696c6f742e737667"><link rel="canonical" href="http://moeyui1.github.io/%E5%BC%80%E5%8F%91/760a5082.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>Istio学习之Pilot-agent | 不是很懂</title><script>function sendPageView(){if(CONFIG.hostname===location.hostname){var e=localStorage.getItem("uid")||Math.random()+"."+Math.random();localStorage.setItem("uid",e),navigator.sendBeacon("https://www.google-analytics.com/collect",new URLSearchParams({v:1,tid:"UA-75483578-1",cid:e,t:"pageview",dp:encodeURIComponent(location.pathname)}))}}document.addEventListener("pjax:complete",sendPageView),sendPageView()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><script>function loadCss(e){var n=document,s=n.head,t=n.createElement("link");t.rel="stylesheet",t.href=e,function e(s){if(n.body)return s();setTimeout(function(){e(s)})}(function(){s.appendChild(t)})}loadCss("/style.css"),loadCss("//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"),loadCss("//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css")</script><noscript><link rel="stylesheet" href="/style.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"></noscript></head><body itemscope="" itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">不是很懂</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">不是很懂你们程序员</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> 首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> 归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i> 分类</a></li></ul></nav></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/moeyui1" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://moeyui1.github.io/%E5%BC%80%E5%8F%91/760a5082.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/blogAvatar.jpg"><meta itemprop="name" content="moeyui"><meta itemprop="description" content="moeyui | moeyui's blog"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="不是很懂"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Istio学习之Pilot-agent</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-09-09 14:09:06" itemprop="dateCreated datePublished" datetime="2018-09-09T14:09:06+08:00">2018-09-09</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-02-08 18:12:18" itemprop="dateModified" datetime="2021-02-08T18:12:18+08:00">2021-02-08</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a></span></span><span id="/%E5%BC%80%E5%8F%91/760a5082.html" class="post-meta-item leancloud_visitors" data-flag-title="Istio学习之Pilot-agent" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Valine：</span><a title="valine" href="/%E5%BC%80%E5%8F%91/760a5082.html#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/%E5%BC%80%E5%8F%91/760a5082.html" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><p>Pilot 是 Istio 中一个重要的组件，它主要分为 Agent 和 Discovery Services 两部分。本文着重介绍下承担 Envoy 保姆一职的 Agent。</p><p><img data-src="https://camo.githubusercontent.com/919e2e3cd8e4267a00035b813df53902864a3388/68747470733a2f2f63646e2e7261776769742e636f6d2f697374696f2f70696c6f742f6d61737465722f646f632f70696c6f742e737667" alt="Pilot"></p><span id="more"></span><h1 id="功能简述"><a href="#功能简述" class="headerlink" title="功能简述"></a>功能简述</h1><p>在proxy镜像中，pilot-agent 负责的工作包括：</p><ol><li>生成envoy的配置：指的是生成 Envoy 的启动配置</li><li>启动envoy</li><li>监控并管理envoy的运行状况，比如envoy出错时pilot-agent负责重启envoy，或者envoy配置变更后reload envoy</li></ol><p>而 envoy 负责接受所有发往该pod的网络流量，分发所有从pod中发出的网络流量。</p><blockquote><p>根据代码中的<code>sidecar-injector-configmap.yaml</code>（用来配置如何自动化地inject istio sidecar），inject过程中，除了proxy镜像作为sidecar之外，每个pod还会带上initcontainer（Kubernetes中的概念），具体镜像为proxy_init。proxy_init通过注入iptables规则改写流入流出pod的网络流量规则，使得流入流出pod的网络流量重定向到proxy的监听端口，而应用对此无感。</p></blockquote><p><img data-src="https://i.loli.net/2018/09/09/5b94b1c621c56.png" alt="istio-pilot-proxy (2).png"></p><p>注意上图中 Envoy 处于 Istio/proxy 的内层。这是因为 Istio 并非直接使用 Envoy ，而是在其之上有一层定制，具体可见 <a target="_blank" rel="noopener" href="https://github.com/istio/proxy">Istio/proxy</a> 这个项目。</p><blockquote><p>The Istio proxy contains extensions to the Envoy proxy (in the form of Envoy filters), that allow the proxy to delegate policy enforcement decisions to Mixer.</p><p>Istio/proxy 项目包含 Envoy 扩展（由 Envoy filters 构成），允许 proxy 将策略强制决策委托给 Mixer。</p></blockquote><p>这就解释了 Proxy 是如何与 Mixer 交互的。</p><h1 id="部署存在形式"><a href="#部署存在形式" class="headerlink" title="部署存在形式"></a>部署存在形式</h1><p>pilot-agent在pilot/cmd包下面，<strong>是个单独的二进制</strong>。</p><p>pilot-agent<strong>跟 envoy 打包在同一个docker镜像里</strong>，镜像由<code>Dockerfile.proxy</code>定义。Makefile（include了<code>tools/istio-docker.mk</code>）把这个dockerfile build成了<code>${HUB}/proxyv2:${TAG}</code>镜像，也就是 Kubernetes 里跟应用放在同一个pod下的sidecar。</p><p><em>非Kubernetes情况下需要把pilot-agent、envoy跟应用部署在一起，惊了。</em></p><h1 id="生成envoy的配置"><a href="#生成envoy的配置" class="headerlink" title="生成envoy的配置"></a>生成envoy的配置</h1><p>略</p><h1 id="Envoy-的监控和管理"><a href="#Envoy-的监控和管理" class="headerlink" title="Envoy 的监控和管理"></a>Envoy 的监控和管理</h1><p>为envoy生成好配置文件之后，pilot-agent还要负责envoy进程的监控与管理工作，包括：</p><ol><li>创建envoy对象，结构体包含proxyConfig（前面步骤中为envoy生成的配置信息），role.serviceNode(似乎是agent唯一标识符），loglevel和pilotsan（service account name）</li><li>创建agent对象，包含前面创建的envoy结构体，一个epochs的map，3个channel：configCh, statusCh和abortCh</li><li>创建watcher并启动协程执行watcher.Run watcher.Run首先启动协程执行agent.Run（<strong>agent的主循环</strong>），然后调用watcher.Reload(kickstart the proxy with partial state (in case there are no notifications coming))，<strong>Reload会调用agent.ScheduleConfigUpdate，并最终导致第一个envoy进程启动，见后面分析</strong>。然后监控各种证书，如果证书文件发生变化，则调用ScheduleConfigUpdate来reload envoy，然后watcher.retrieveAZ(TODO)</li><li>创建context，调用cmd.WaitSignal以等待进程接收到SIGINT, SIGTERM信号，接受到信号之后通过context通知agent，agent接到通知后调用terminate来kill所有envoy进程，并退出agent进程</li></ol><blockquote><p>上面的pilot/pkg/proxy包下的agent中采用Proxy接口管理pilot/pkg/proxy/envoy包下的envoy对象，从理论上来说也可以把envoy换成其他proxy实现管理。不过此事还牵扯discovery service等其他组件。</p></blockquote><p>上面第三步启动协程执行的agent.Run是agent的主循环，会一直通过监听以下几个channel来监控envoy进程：</p><ol><li>agent的configCh:如果配置文件，<strong>主要是那些证书文件发生变化</strong>，则调用agent.reconcile来reload envoy</li><li>statusCh:这里的status其实就是exitStatus，处理envoy进程退出状态，处理流程如下：<ol><li>把刚刚退出的epoch从agent维护的两个map里删了，后面会讲到这两个map。把agent.currentConfig置为agent.latestEpoch对应的config，因为agent在reconcile的过程中只有在desired config和current config不同的时候才会创建新的epoch，所以这里把currentConfig设置为上一个config之后，必然会造成下一次reconcile的时候current与desired不等，从而创建新的envoy</li><li>如果exitStatus.err是errAbort，表示是agent让envoy退出的（这个error是调用agent.abortAll时发出的），这时只要log记录epoch序列号为xxx的envoy进程退出了</li><li>如果exitStatus.err并非errAbort，则log记录epoch异常退出，并给所有当前正在运行的其他epoch进程对应的abortCh发出errAbort，所以后续其他envoy进程也都会被kill掉，并全都往agent.statusCh写入exitStatus，当前的流程会全部再为每个epoch进程走一遍</li><li>如果是其他exitStatus（什么时候会进入这个否则情况？比如exitStatus.err是wait epoch进程得到的正常退出信息，即nil），则log记录envoy正常退出</li><li>调用envoy.Cleanup，删除刚刚退出的envoy进程对应的配置文件，文件路径由ConfigPath和epoch序列号串起来得到</li><li>如果envoy进程为非正常退出，也就是除了“否则”描述的case之外的2中情况，则试图恢复刚刚退出的envoy进程（可见前面向所有其他进程发出errAbort消息的意思，并非永远停止envoy，pilot-agent接下来马上就会重启被abort的envoy）。恢复方式并不是当场启动新的envoy，而是schedule一次reconcile。如果启动不成功，可以在得到exitStatus之后再次schedule（每次间隔时间为 $2^n*200$ 毫秒 ），最多重试10次（budget），如果10次都失败，则退出整个golang的进程（os.Exit）,由容器环境决定如何恢复pilot-agent。所谓的schedule，就是往agent.retry.restart写入一个预定的未来的某个时刻，并扣掉一次budget（budget在每次reconcile之前都会被重置为10），然后就结束当前循环。在下一个开始的时候，会检测agent.retry.restart，如果非空，则计算距离reconcile的时间delay</li></ol></li><li>time.After（delay）:监听是否到时间执行schedule的reconcile了，到了则执行agent.reconcile</li><li>ctx.Done:执行agent.terminate terminate方法比较简单，向所有的envoy进程的abortCh发出errAbort消息，造成他们全体被kill（Cmd.Kill），然后agent自己return，退出当前的循环，这样就不会有人再去重启envoy</li></ol><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *agent)</span> <span class="title">Run</span><span class="params">(ctx context.Context)</span></span> {</span><br><span class="line">	log.Info(<span class="string">"Starting proxy agent"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Throttle processing up to smoothed 1 qps with bursts up to 10 qps.</span></span><br><span class="line">	<span class="comment">// High QPS is needed to process messages on all channels.</span></span><br><span class="line">	rateLimiter := rate.NewLimiter(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> {</span><br><span class="line">	err := rateLimiter.Wait(ctx)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			a.terminate()</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// maximum duration or duration till next restart</span></span><br><span class="line">		<span class="keyword">var</span> delay time.Duration = <span class="number">1</span>&lt;&lt;<span class="number">63</span> - <span class="number">1</span></span><br><span class="line">		<span class="keyword">if</span> a.retry.restart != <span class="literal">nil</span> {</span><br><span class="line">			delay = time.Until(*a.retry.restart)</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">select</span> {</span><br><span class="line">		<span class="keyword">case</span> config := &lt;-a.configCh:</span><br><span class="line">			<span class="keyword">if</span> !reflect.DeepEqual(a.desiredConfig, config) {</span><br><span class="line">				log.Infof(<span class="string">"Received new config, resetting budget"</span>)</span><br><span class="line">				a.desiredConfig = config</span><br><span class="line"></span><br><span class="line">				<span class="comment">// reset retry budget if and only if the desired config changes</span></span><br><span class="line">				a.retry.budget = a.retry.MaxRetries</span><br><span class="line">				a.reconcile()</span><br><span class="line">			}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> status := &lt;-a.statusCh:</span><br><span class="line">			<span class="comment">// delete epoch record and update current config</span></span><br><span class="line">			<span class="comment">// avoid self-aborting on non-abort error</span></span><br><span class="line">			<span class="built_in">delete</span>(a.epochs, status.epoch)</span><br><span class="line">			<span class="built_in">delete</span>(a.abortCh, status.epoch)</span><br><span class="line">			a.currentConfig = a.epochs[a.latestEpoch()]</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> status.err == errAbort {</span><br><span class="line">				log.Infof(<span class="string">"Epoch %d aborted"</span>, status.epoch)</span><br><span class="line">			} <span class="keyword">else</span> <span class="keyword">if</span> status.err != <span class="literal">nil</span> {</span><br><span class="line">				log.Warnf(<span class="string">"Epoch %d terminated with an error: %v"</span>, status.epoch, status.err)</span><br><span class="line"></span><br><span class="line">				<span class="comment">// <span class="doctag">NOTE:</span> due to Envoy hot restart race conditions, an error from the</span></span><br><span class="line">				<span class="comment">// process requires aggressive non-graceful restarts by killing all</span></span><br><span class="line">				<span class="comment">// existing proxy instances</span></span><br><span class="line">				a.abortAll()</span><br><span class="line">			} <span class="keyword">else</span> {</span><br><span class="line">				log.Infof(<span class="string">"Epoch %d exited normally"</span>, status.epoch)</span><br><span class="line">			}</span><br><span class="line"></span><br><span class="line">			<span class="comment">// cleanup for the epoch</span></span><br><span class="line">			a.proxy.Cleanup(status.epoch)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// schedule a retry for an error.</span></span><br><span class="line">			<span class="comment">// the current config might be out of date from here since its proxy might have been aborted.</span></span><br><span class="line">			<span class="comment">// the current config will change on abort, hence retrying prior to abort will not progress.</span></span><br><span class="line">			<span class="comment">// that means that aborted envoy might need to re-schedule a retry if it was not already scheduled.</span></span><br><span class="line">			<span class="keyword">if</span> status.err != <span class="literal">nil</span> {</span><br><span class="line">				<span class="comment">// skip retrying twice by checking retry restart delay</span></span><br><span class="line">				<span class="keyword">if</span> a.retry.restart == <span class="literal">nil</span> {</span><br><span class="line">					<span class="keyword">if</span> a.retry.budget &gt; <span class="number">0</span> {</span><br><span class="line">						delayDuration := a.retry.InitialInterval * (<span class="number">1</span> &lt;&lt; <span class="keyword">uint</span>(a.retry.MaxRetries-a.retry.budget))</span><br><span class="line">						restart := time.Now().Add(delayDuration)</span><br><span class="line">						a.retry.restart = &amp;restart</span><br><span class="line">						a.retry.budget = a.retry.budget - <span class="number">1</span></span><br><span class="line">						log.Infof(<span class="string">"Epoch %d: set retry delay to %v, budget to %d"</span>, status.epoch, delayDuration, a.retry.budget)</span><br><span class="line">					} <span class="keyword">else</span> {</span><br><span class="line">						log.Error(<span class="string">"Permanent error: budget exhausted trying to fulfill the desired configuration"</span>)</span><br><span class="line">						a.proxy.Panic(status.epoch)</span><br><span class="line">						<span class="keyword">return</span></span><br><span class="line">					}</span><br><span class="line">				} <span class="keyword">else</span> {</span><br><span class="line">					log.Debugf(<span class="string">"Epoch %d: restart already scheduled"</span>, status.epoch)</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> &lt;-time.After(delay):</span><br><span class="line">			a.reconcile()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> _, more := &lt;-ctx.Done():</span><br><span class="line">			<span class="keyword">if</span> !more {</span><br><span class="line">				a.terminate()</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h1 id="Envoy-启动流程"><a href="#Envoy-启动流程" class="headerlink" title="Envoy 启动流程"></a>Envoy 启动流程</h1><h2 id="热重启"><a href="#热重启" class="headerlink" title="热重启"></a>热重启</h2><p>Pilot agent 的职责之一就是重启proxy，一般是Envoy。可以支持Envoy的热重启。</p><blockquote><p>Agent manages the restarts and the life cycle of a proxy binary. Agent keeps track of all running proxy epochs and their configurations. Hot restarts are performed by launching a new proxy process with a strictly incremented restart epoch. <strong>It is up to the proxy to ensure that older epochs gracefully shutdown and carry over all the necessary state to the latest epoch. The agent does not terminate older epochs.</strong> The initial epoch is 0.</p></blockquote><p>旧实例是否完全关闭，并将必要的状态数据迁移到新实例是由 Proxy 负责的（Agent 不会管）。Agent 不会关闭旧实例。言下之意，Proxy 自己负责旧实例的处理。</p><blockquote><p>The restart protocol matches Envoy semantics for restart epochs: to successfully launch a new Envoy process that will replace the running Envoy processes, the restart epoch of the new process must be exactly 1 greater than the highest restart epoch of the currently running Envoy processes. See <a target="_blank" rel="noopener" href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/hot_restart.html">https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/hot_restart.html</a> for more information about the Envoy hot restart protocol. Agent requires two functions “run” and “cleanup”. Run function is a call to start the proxy and must block until the proxy exits. Cleanup function is executed immediately after the proxy exits and must be non-blocking since it is executed synchronously in the main agent control loop. Both functions take the proxy epoch as an argument. A typical scenario would involve epoch 0 followed by a failed epoch 1 start. The agent then attempts to start epoch 1 again.</p></blockquote><blockquote><p>Whenever the run function returns an error, the agent assumes that the proxy failed to start and attempts to restart the proxy several times with an exponential back-off. The subsequent restart attempts may reuse the epoch from the failed attempt. Retry budgets are allocated whenever the desired configuration changes.</p></blockquote><blockquote><p>Agent executes a single control loop that receives notifications about scheduled configuration updates, exits from older proxy epochs, and retry attempt timers. The call to schedule a configuration update will block until the control loop is ready to accept and process the configuration update.</p></blockquote><p>热重启的流程：</p><ol><li>启动另外一个envoy2进程（Secondary process）</li><li>envoy2通知envoy1（Primary process）关闭其管理的端口，由envoy2接管</li><li>通过UDS把envoy1可用的listen sockets拿过来</li><li>envoy2初始化成功，通知envoy1在一段时间内（drain-time-s）优雅关闭正在工作的请求</li><li>到了时间（parent-shutdown-time-s），envoy2通知envoy1自行关闭</li><li>envoy2升级为envoy1</li></ol><blockquote><p>从上面的执行步骤来看，poilt-agent <strong>只负责启动另一个envoy进程</strong>，其他由envoy自行处理。</p></blockquote><h2 id="抢救-Envoy"><a href="#抢救-Envoy" class="headerlink" title="抢救 Envoy"></a>抢救 Envoy</h2><blockquote><p>envoy是一个服务，既然是服务都不可能保证100%的可用，如果envoy不幸运宕掉了，那么pilot-agent如何进行抢救，保证envoy高可用？</p></blockquote><h3 id="获取退出状态"><a href="#获取退出状态" class="headerlink" title="获取退出状态"></a>获取退出状态</h3><blockquote><p>在上面提到pilot-agent启动envoy后，会监听envoy的退出状态，发现非正常退出状态，就会抢救envoy。</p></blockquote><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(proxy envoy)</span> <span class="title">Run</span><span class="params">(config <span class="keyword">interface</span>{}, epoch <span class="keyword">int</span>, abort &lt;-<span class="keyword">chan</span> error)</span> <span class="title">error</span></span> {</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// Set if the caller is monitoring envoy, for example in tests or if envoy runs in same</span></span><br><span class="line">    <span class="comment">// container with the app.</span></span><br><span class="line">    <span class="keyword">if</span> proxy.errChan != <span class="literal">nil</span> {</span><br><span class="line">      <span class="comment">// Caller passed a channel, will wait itself for termination</span></span><br><span class="line">      <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        proxy.errChan &lt;- cmd.Wait()</span><br><span class="line">      }()</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> error, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">      done &lt;- cmd.Wait()</span><br><span class="line">    }()</span><br><span class="line">    ......</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="抢救envoy"><a href="#抢救envoy" class="headerlink" title="抢救envoy"></a>抢救envoy</h3><blockquote><p>使用 kill -9 可以模拟envoy非正常退出状态。当出现非正常退出，pilot-agent的抢救机制会被触发。如果第一次抢救成功，那当然是好，如果失败了，pilot-agent会继续抢救，最多抢救10次，每次间隔时间为 2 n <em>100</em> time.Millisecond。超过10次都没有救活，pilit-agent就会放弃抢救，宣布死亡，并且退出istio/proxy，让k8s重新启动一个新容器。</p></blockquote><p><code>istio.io/istio/pilot/pkg/proxy/agent.go #164</code></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *agent)</span> <span class="title">Run</span><span class="params">(ctx context.Context)</span></span> {</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">for</span> {</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">select</span> {</span><br><span class="line">        ......</span><br><span class="line">    <span class="keyword">case</span> status := &lt;-a.statusCh:</span><br><span class="line">        ......</span><br><span class="line">      <span class="keyword">if</span> status.err == errAbort {</span><br><span class="line">        <span class="comment">//pilot-agent通知退出 或 envoy非正常退出</span></span><br><span class="line">        log.Infof(<span class="string">"Epoch %d aborted"</span>, status.epoch)</span><br><span class="line">      } <span class="keyword">else</span> <span class="keyword">if</span> status.err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="comment">//envoy非正常退出</span></span><br><span class="line">        log.Warnf(<span class="string">"Epoch %d terminated with an error: %v"</span>, status.epoch, status.err)</span><br><span class="line">                ......</span><br><span class="line">        a.abortAll()</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">//正常退出</span></span><br><span class="line">        log.Infof(<span class="string">"Epoch %d exited normally"</span>, status.epoch)</span><br><span class="line">      }</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> status.err != <span class="literal">nil</span> {</span><br><span class="line">      <span class="comment">// skip retrying twice by checking retry restart delay</span></span><br><span class="line">      <span class="keyword">if</span> a.retry.restart == <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">if</span> a.retry.budget &gt; <span class="number">0</span> {</span><br><span class="line">          delayDuration := a.retry.InitialInterval * (<span class="number">1</span> &lt;&lt; <span class="keyword">uint</span>(a.retry.MaxRetries-a.retry.budget))</span><br><span class="line">          restart := time.Now().Add(delayDuration)</span><br><span class="line">          a.retry.restart = &amp;restart</span><br><span class="line">          a.retry.budget = a.retry.budget - <span class="number">1</span></span><br><span class="line">          log.Infof(<span class="string">"Epoch %d: set retry delay to %v, budget to %d"</span>, status.epoch, delayDuration, a.retry.budget)</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">          <span class="comment">//宣布死亡，退出istio/proxy</span></span><br><span class="line">          log.Error(<span class="string">"Permanent error: budget exhausted trying to fulfill the desired configuration"</span>)</span><br><span class="line">          a.proxy.Panic(a.desiredConfig)</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        }</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        log.Debugf(<span class="string">"Epoch %d: restart already scheduled"</span>, status.epoch)</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">case</span> &lt;-time.After(delay):</span><br><span class="line">        ......</span><br><span class="line">    <span class="keyword">case</span> _, more := &lt;-ctx.Done():</span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><code>istio.io/istio/pilot/pkg/proxy/agent.go #72</code></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  errAbort = errors.New(<span class="string">"epoch aborted"</span>)</span><br><span class="line">  <span class="comment">// DefaultRetry configuration for proxies</span></span><br><span class="line">  DefaultRetry = Retry{</span><br><span class="line">    MaxRetries:      <span class="number">10</span>,</span><br><span class="line">    InitialInterval: <span class="number">200</span> * time.Millisecond,</span><br><span class="line">  }</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a target="_blank" rel="noopener" href="http://www.servicemesher.com/blog/istio-service-mesh-source-code-pilot-agent-deepin">Service Mesh深度学习系列part1—istio源码分析之pilot-agent模块分析</a></li><li> <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000015171622">istio源码分析——pilot-agent如何管理envoy生命周期</a></li></ol><h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><ol><li><h2 id="Agent-生成-Envoy-的配置？"><a href="#Agent-生成-Envoy-的配置？" class="headerlink" title="Agent 生成 Envoy 的配置？"></a>Agent 生成 Envoy 的配置？</h2><p>指的是结合用户自定义配置生成 Envoy 的启动参数配置。</p></li><li><h2 id="Agent-在-Envoy-热重启中扮演什么角色？"><a href="#Agent-在-Envoy-热重启中扮演什么角色？" class="headerlink" title="Agent 在 Envoy 热重启中扮演什么角色？"></a>Agent 在 Envoy 热重启中扮演什么角色？</h2><p>Agent <strong>只负责启动另一个envoy进程</strong>，其他由envoy自行处理。</p></li></ol></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/Istio/" rel="tag"># Istio</a> <a href="/tags/meituan/" rel="tag"># meituan</a> <a href="/tags/service-mesh/" rel="tag"># service mesh</a></div><div class="post-nav"><div class="post-nav-item"><a href="/%E5%BC%80%E5%8F%91/9cf44367.html" rel="prev" title="优雅地调试 Envoy"><i class="fa fa-chevron-left"></i> 优雅地调试 Envoy</a></div><div class="post-nav-item"> <a href="/%E5%BC%80%E5%8F%91/ff55e9f.html" rel="next" title="Istio学习之Pilot-Discovery">Istio学习之Pilot-Discovery<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD%E7%AE%80%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">功能简述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E5%AD%98%E5%9C%A8%E5%BD%A2%E5%BC%8F"><span class="nav-number">2.</span> <span class="nav-text">部署存在形式</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%94%9F%E6%88%90envoy%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-number">3.</span> <span class="nav-text">生成envoy的配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Envoy-%E7%9A%84%E7%9B%91%E6%8E%A7%E5%92%8C%E7%AE%A1%E7%90%86"><span class="nav-number">4.</span> <span class="nav-text">Envoy 的监控和管理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Envoy-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="nav-number">5.</span> <span class="nav-text">Envoy 启动流程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%83%AD%E9%87%8D%E5%90%AF"><span class="nav-number">5.1.</span> <span class="nav-text">热重启</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%A2%E6%95%91-Envoy"><span class="nav-number">5.2.</span> <span class="nav-text">抢救 Envoy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E9%80%80%E5%87%BA%E7%8A%B6%E6%80%81"><span class="nav-number">5.2.1.</span> <span class="nav-text">获取退出状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%A2%E6%95%91envoy"><span class="nav-number">5.2.2.</span> <span class="nav-text">抢救envoy</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">6.</span> <span class="nav-text">参考</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FAQ"><span class="nav-number">7.</span> <span class="nav-text">FAQ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Agent-%E7%94%9F%E6%88%90-Envoy-%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%9F"><span class="nav-number">7.1.</span> <span class="nav-text">Agent 生成 Envoy 的配置？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Agent-%E5%9C%A8-Envoy-%E7%83%AD%E9%87%8D%E5%90%AF%E4%B8%AD%E6%89%AE%E6%BC%94%E4%BB%80%E4%B9%88%E8%A7%92%E8%89%B2%EF%BC%9F"><span class="nav-number">7.2.</span> <span class="nav-text">Agent 在 Envoy 热重启中扮演什么角色？</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="moeyui" src="/images/blogAvatar.jpg"><p class="site-author-name" itemprop="name">moeyui</p><div class="site-description" itemprop="description">moeyui | moeyui's blog</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">40</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">7</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">37</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/moeyui1" title="GitHub → https://github.com/moeyui1" rel="noopener" target="_blank"><i class="github fa-fw"></i> GitHub</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> © 2015 – <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa-user"></i></span> <span class="author" itemprop="copyrightHolder">moeyui</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> &amp; <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div></div></footer></div><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script><script src="/bundle.js"></script><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  };(function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();;NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'Nk9tNzbllEl79DVtRiOuLmbm-gzGzoHsz',
      appKey     : 'uPzxSfSzF95Gav6vGx2dOhCq',
      placeholder: "Just go go",
      avatar     : 'retro',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});</script></body></html>